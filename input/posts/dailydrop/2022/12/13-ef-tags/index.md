---
title: "EF tags and interceptors"
lead: "Modifying EF generated SQL with tags and interceptors"
Published: "12/13/2022 01:00:00+0200"
slug: "13-ef-tags"
draft: false
toc: true
categories:
    - DailyDrop
tags:
   - c#
   - .net
   - ef
   - entityframework
   - tag

---

## Daily Knowledge Drop

`Tags`, in conjunction with an `IInterceptor` implementation, can be used to intercept SQL commands before being executed on the database, and modify them to fix the tag requirements.

---


## Setup

In the examples below, we are using DbContext setup the standard way, with a `Blog` DbSet. 

As per normal, to get a list of all _Blogs_:

``` csharp
var normalQuery = context.Blogs.ToList();
```

Next we'll look at how to _tag_ the queries with a `nolock` tag, and then how to _intercept_ the query, look presence of the _tag_, and modify the query to include `nolock`.

---

### Tagging queries

The first step is to _tag_ the query with the `nolock` tag - this is relatively straightforward:

``` csharp
var nolockQuery = context
    .Blogs
    .TagWith("Nolock")
    .ToList();
```

If the generated SQL is inspected, one will see the query is now tagged as follows:

``` sql
-- Nolock

SELECT [b].[Id], [b].[DateCreated], [b].[Description], [b].[Title]
FROM [Blog] AS [b]
```

Step 1 completed!

---

### Interceptor

The next step is to _intercept_ the query before it's executed on the database and modify it - luckily this is also fairly straightforward, as Entity Framework has a built in mechanism for this.

To create an _interceptor_ (in this example) all that is required is to inherit from `DbCommandInterceptor`:

``` csharp
// inherit DbCommandInterceptor
public class NoLockInterceptor : DbCommandInterceptor
{
    // overwrite the ReaderExecuting method
    public override InterceptionResult<DbDataReader> ReaderExecuting(DbCommand command, 
        CommandEventData eventData, 
        InterceptionResult<DbDataReader> result)
    {
        // if the query generated by EF starts with "nolock"
        if(command.CommandText.StartsWith("-- Nolock", StringComparison.Ordinal))
        {
            // append "nolock" to the end
            command.CommandText += " (NOLOCK)";
        }

        return result;
    }
}
```

The `ReaderExecuting` method is executed before the query is about to be executed - in this method, the query is (crudely) checked to see if it has been _tagged_ for `nolock`, and if so, the `NOLOCK` keyword is added to the end of the query.


This is very crude and only for demo purposes - it is not production ready. Ror example, this does not take into account any _WHERE_ statements in the SQL. 

---

### DbContext

Now that we have the _interceptor_ defined, the next step is to register it with EF.

In this demo, this is done in the _OnConfiguring_ method of the `DbContext`:

``` csharp
protected override void OnConfiguring(DbContextOptionsBuilder optionsBuilder)
{
    optionsBuilder.UseSqlServer(
        @"Server=.\SQLEXPRESS;Database=EFTagging;Integrated Security=True;TrustServerCertificate=True");

    // add the interceptor
    optionsBuilder.AddInterceptors(new NoLockInterceptor());
}
```

Configuration is now completed!

---

### Generated SQL

When querying (without an predicate in this sample) and tagging the query, the `nolock` keyword is automatically added:

``` csharp
var context = new DemoContext();

// query without tagging
var normalQuery = context.Blogs.ToList();

//query with the tag
var nolockQuery = context.Blogs.TagWith("Nolock").ToList();
```

The SQL generated by the two queries.

Without the tag:

``` sql
SELECT [b].[Id], [b].[DateCreated], [b].[Description], [b].[Title]
FROM [Blog] AS [b]
```

With the tag:
``` sql
-- Nolock

SELECT [b].[Id], [b].[DateCreated], [b].[Description], [b].[Title]
FROM [Blog] AS [b] (NOLOCK)
```

---

## Notes

A useful and interesting way to combine two EF features - the _tagging_ and _interception_ features. Manually modifying SQL generated by EF can be dangerous as there are a lot of options and variations to the SQL generated - so do it with caution and test extensively.

---


## References

[Dave Callan Tweet](https://twitter.com/DaveCallanIE/status/1599379983817879552)  

<?# DailyDrop ?>221: 13-12-2022<?#/ DailyDrop ?>
